<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>インタラクティブサービス: F# Interactiveの組み込み
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="F# compiler services for creating IDE tools, language extensions and for F# embedding">
    <meta name="author" content="Microsoft Corporation, Dave Thomas, Anh-Dung Phan, Tomas Petricek">

    <script src="http://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="http://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">

    <link type="text/css" rel="stylesheet" href="/FSharp.Compiler.Service/ja/../content/style.ja.css" />
	<link type="text/css" rel="stylesheet" href="/FSharp.Compiler.Service/ja/../content/fcs.css" />
    <script type="text/javascript" src="/FSharp.Compiler.Service/ja/../content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/fsharp/FSharp.Compiler.Service">github page</a></li>
        </ul>
        <h3 class="muted">F# Compiler Services</h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="インタラクティブサービス-F-Interactiveの組み込み" class="anchor" href="#インタラクティブサービス-F-Interactiveの組み込み">インタラクティブサービス: F# Interactiveの組み込み</a></h1>

<p>このチュートリアルでは、独自のアプリケーションに
F# Interactiveを組み込む方法について紹介します。
F# Interactiveは対話式のスクリプティング環境で、
F#コードを高度に最適化されたILコードへとコンパイルしつつ、
それを即座に実行することができます。
F# Interactiveサービスを使用すると、独自のアプリケーションに
F#の評価機能を追加できます。</p>

<blockquote>
  <p><strong>注意:</strong> F# Interactiveは様々な方法で組み込むことができます。
  最も簡単な方法は <code>fsi.exe</code> プロセスとの間で標準入出力経由でやりとりする方法です。
  このチュートリアルではF# Interactiveの機能を.NET APIで
  直接呼び出す方法について紹介します。
  ただし入力用のコントロールを備えていない場合、別プロセスでF# Interactiveを
  起動するのはよい方法だといえます。
  理由の1つとしては <code>StackOverflowException</code> を処理する方法がないため、
  出来の悪いスクリプトによってはホストプロセスが停止させられてしまう
  場合があるからです。</p>
</blockquote>

<p>しかしそれでもF# InteractiveサービスにはF# Interactiveを実行ファイルに埋め込んで
実行出来る(そしてアプリケーションの各機能とやりとり出来る)、あるいは
機能限定されたF#コード(たとえば独自のDSLによって生成されたコード)だけを
実行させることが出来るという便利さがあります。</p>

<h2><a name="F-Interactiveの開始" class="anchor" href="#F-Interactiveの開始">F# Interactiveの開始</a></h2>

<p>まずF# Interactiveサービスを含むライブラリへの参照を追加します:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#r</span> <span class="s">&quot;FSharp.Compiler.Service.dll&quot;</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">Microsoft</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">FSharp</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 3)" onmouseover="showTip(event, 'fs3', 3)" class="i">Compiler</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs4', 4)" onmouseover="showTip(event, 'fs4', 4)" class="i">Interactive</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs5', 5)" onmouseover="showTip(event, 'fs5', 5)" class="i">Shell</span>
</code></pre></td>
</tr>
</table>

<p>F# Interactiveとやりとりするには、入出力を表すストリームを作成する必要があります。
これらのストリームを使用することで、
いくつかのF#コードに対する評価結果を後から出力することができます:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span onmouseout="hideTip(event, 'fs6', 6)" onmouseover="showTip(event, 'fs6', 6)" class="i">System</span>
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="i">System</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="i">IO</span>

<span class="c">// 入出力のストリームを初期化</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs8', 9)" onmouseover="showTip(event, 'fs8', 9)" class="i">sbOut</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs9', 10)" onmouseover="showTip(event, 'fs9', 10)" class="i">Text</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 11)" onmouseover="showTip(event, 'fs10', 11)" class="t">StringBuilder</span>()
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs11', 12)" onmouseover="showTip(event, 'fs11', 12)" class="i">sbErr</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs9', 13)" onmouseover="showTip(event, 'fs9', 13)" class="i">Text</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 14)" onmouseover="showTip(event, 'fs10', 14)" class="t">StringBuilder</span>()
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs12', 15)" onmouseover="showTip(event, 'fs12', 15)" class="i">inStream</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs13', 16)" onmouseover="showTip(event, 'fs13', 16)" class="t">StringReader</span>(<span class="s">&quot;&quot;</span>)
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs14', 17)" onmouseover="showTip(event, 'fs14', 17)" class="i">outStream</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs15', 18)" onmouseover="showTip(event, 'fs15', 18)" class="t">StringWriter</span>(<span onmouseout="hideTip(event, 'fs8', 19)" onmouseover="showTip(event, 'fs8', 19)" class="i">sbOut</span>)
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs16', 20)" onmouseover="showTip(event, 'fs16', 20)" class="i">errStream</span> <span class="o">=</span> <span class="k">new</span> <span onmouseout="hideTip(event, 'fs15', 21)" onmouseover="showTip(event, 'fs15', 21)" class="t">StringWriter</span>(<span onmouseout="hideTip(event, 'fs11', 22)" onmouseover="showTip(event, 'fs11', 22)" class="i">sbErr</span>)

<span class="c">// コマンドライン引数を組み立てて、FSIセッションを開始する</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs17', 23)" onmouseover="showTip(event, 'fs17', 23)" class="i">argv</span> <span class="o">=</span> [| <span class="s">&quot;C:</span><span class="e">\\</span><span class="s">fsi.exe&quot;</span> |]
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs18', 24)" onmouseover="showTip(event, 'fs18', 24)" class="i">allArgs</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs19', 25)" onmouseover="showTip(event, 'fs19', 25)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs20', 26)" onmouseover="showTip(event, 'fs20', 26)" class="f">append</span> <span onmouseout="hideTip(event, 'fs17', 27)" onmouseover="showTip(event, 'fs17', 27)" class="i">argv</span> [|<span class="s">&quot;--noninteractive&quot;</span>|]

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs21', 28)" onmouseover="showTip(event, 'fs21', 28)" class="i">fsiConfig</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs22', 29)" onmouseover="showTip(event, 'fs22', 29)" class="t">FsiEvaluationSession</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs23', 30)" onmouseover="showTip(event, 'fs23', 30)" class="f">GetDefaultConfiguration</span>()
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs24', 31)" onmouseover="showTip(event, 'fs24', 31)" class="i">fsiSession</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs22', 32)" onmouseover="showTip(event, 'fs22', 32)" class="t">FsiEvaluationSession</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs25', 33)" onmouseover="showTip(event, 'fs25', 33)" class="f">Create</span>(<span onmouseout="hideTip(event, 'fs21', 34)" onmouseover="showTip(event, 'fs21', 34)" class="i">fsiConfig</span>, <span onmouseout="hideTip(event, 'fs18', 35)" onmouseover="showTip(event, 'fs18', 35)" class="i">allArgs</span>, <span onmouseout="hideTip(event, 'fs12', 36)" onmouseover="showTip(event, 'fs12', 36)" class="i">inStream</span>, <span onmouseout="hideTip(event, 'fs14', 37)" onmouseover="showTip(event, 'fs14', 37)" class="i">outStream</span>, <span onmouseout="hideTip(event, 'fs16', 38)" onmouseover="showTip(event, 'fs16', 38)" class="i">errStream</span>)  
</code></pre></td>
</tr>
</table>

<h2><a name="コードの評価および実行" class="anchor" href="#コードの評価および実行">コードの評価および実行</a></h2>

<p>F# Interactiveサービスにはサービスとやりとりするためのメソッドが2つ用意されています。
1つは <code>EvalExpression</code> で、式を評価してその結果を返します。
結果には戻り値が( <code>obj</code> として)含まれる他、値に対して静的に推測された型も含まれます:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">/// 式を評価して結果を返す</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs26', 39)" onmouseover="showTip(event, 'fs26', 39)" class="f">evalExpression</span> <span onmouseout="hideTip(event, 'fs27', 40)" onmouseover="showTip(event, 'fs27', 40)" class="i">text</span> <span class="o">=</span>
  <span class="k">match</span> <span onmouseout="hideTip(event, 'fs24', 41)" onmouseover="showTip(event, 'fs24', 41)" class="i">fsiSession</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs28', 42)" onmouseover="showTip(event, 'fs28', 42)" class="f">EvalExpression</span>(<span onmouseout="hideTip(event, 'fs27', 43)" onmouseover="showTip(event, 'fs27', 43)" class="i">text</span>) <span class="k">with</span>
  | <span onmouseout="hideTip(event, 'fs29', 44)" onmouseover="showTip(event, 'fs29', 44)" class="p">Some</span> <span onmouseout="hideTip(event, 'fs30', 45)" onmouseover="showTip(event, 'fs30', 45)" class="i">value</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs31', 46)" onmouseover="showTip(event, 'fs31', 46)" class="f">printfn</span> <span class="s">&quot;</span><span class="pf">%A</span><span class="s">&quot;</span> <span onmouseout="hideTip(event, 'fs30', 47)" onmouseover="showTip(event, 'fs30', 47)" class="i">value</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs32', 48)" onmouseover="showTip(event, 'fs32', 48)" class="i">ReflectionValue</span>
  | <span onmouseout="hideTip(event, 'fs33', 49)" onmouseover="showTip(event, 'fs33', 49)" class="p">None</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs31', 50)" onmouseover="showTip(event, 'fs31', 50)" class="f">printfn</span> <span class="s">&quot;結果が得られませんでした！&quot;</span>
</code></pre></td>
</tr>
</table>

<p>一方、 <code>EvalInteraction</code> メソッドは結果を返しません。
このメソッドは画面出力機能であったり、F#の式としては不正なものの、
F# Interactiveコンソールには入力できるようなものなど、
副作用を伴う命令を評価する場合に使用できます。
たとえば <code>#time "on"</code> (あるいはその他のディレクティブ)や <code>open System</code> 、
その他のトップレベルステートメントなどが該当します。</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">/// 命令を評価して、結果は無視する</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs34', 51)" onmouseover="showTip(event, 'fs34', 51)" class="f">evalInteraction</span> <span onmouseout="hideTip(event, 'fs27', 52)" onmouseover="showTip(event, 'fs27', 52)" class="i">text</span> <span class="o">=</span> 
  <span onmouseout="hideTip(event, 'fs24', 53)" onmouseover="showTip(event, 'fs24', 53)" class="i">fsiSession</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs35', 54)" onmouseover="showTip(event, 'fs35', 54)" class="f">EvalInteraction</span>(<span onmouseout="hideTip(event, 'fs27', 55)" onmouseover="showTip(event, 'fs27', 55)" class="i">text</span>)
</code></pre></td>
</tr>
</table>

<p>これら2つのメソッドは文字列を引数にとり、
それをF#コードとして評価(あるいは実行)します。
指定するコードの終端に <code>;;</code> を入力する必要はありません。
実行したいコードだけを入力します:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs26', 56)" onmouseover="showTip(event, 'fs26', 56)" class="f">evalExpression</span> <span class="s">&quot;42+1&quot;</span>
<span onmouseout="hideTip(event, 'fs34', 57)" onmouseover="showTip(event, 'fs34', 57)" class="f">evalInteraction</span> <span class="s">&quot;printfn </span><span class="e">\&quot;</span><span class="s">bye</span><span class="e">\&quot;</span><span class="s">&quot;</span>
</code></pre></td>
</tr>
</table>

<p><code>EvalScript</code> メソッドを使用すると、完全な .fsx スクリプトを評価することができます。</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">/// スクリプトを評価して結果を無視する</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs36', 58)" onmouseover="showTip(event, 'fs36', 58)" class="f">evalScript</span> <span onmouseout="hideTip(event, 'fs37', 59)" onmouseover="showTip(event, 'fs37', 59)" class="i">scriptPath</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs24', 60)" onmouseover="showTip(event, 'fs24', 60)" class="i">fsiSession</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs38', 61)" onmouseover="showTip(event, 'fs38', 61)" class="f">EvalScript</span>(<span onmouseout="hideTip(event, 'fs37', 62)" onmouseover="showTip(event, 'fs37', 62)" class="i">scriptPath</span>)

<span onmouseout="hideTip(event, 'fs36', 63)" onmouseover="showTip(event, 'fs36', 63)" class="f">evalScript</span> <span class="s">&quot;sample.fsx&quot;</span>
</code></pre></td>
</tr>
</table>

<h2><a name="評価コンテキスト内での型チェック" class="anchor" href="#評価コンテキスト内での型チェック">評価コンテキスト内での型チェック</a></h2>

<p>F# Interactiveの一連のスクリプティングセッション中で
コードの型チェックを実行したいような状況を考えてみましょう。
たとえばまず宣言を評価します:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs34', 64)" onmouseover="showTip(event, 'fs34', 64)" class="f">evalInteraction</span> <span class="s">&quot;let xxx = 1 + 1&quot;</span>
</code></pre></td>
</tr>
</table>

<p>次に部分的に完全な <code>xxx + xx</code> というコードの型チェックを実行したいとします:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'fs39', 65)" onmouseover="showTip(event, 'fs39', 65)" class="i">parseResults</span>, <span onmouseout="hideTip(event, 'fs40', 66)" onmouseover="showTip(event, 'fs40', 66)" class="i">checkResults</span>, <span onmouseout="hideTip(event, 'fs41', 67)" onmouseover="showTip(event, 'fs41', 67)" class="i">checkProjectResults</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs24', 68)" onmouseover="showTip(event, 'fs24', 68)" class="i">fsiSession</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs42', 69)" onmouseover="showTip(event, 'fs42', 69)" class="f">ParseAndCheckInteraction</span>(<span class="s">&quot;xxx + xx&quot;</span>)
</code></pre></td>
</tr>
</table>

<p><code>parseResults</code> と <code>checkResults</code> はそれぞれ <a href="editor.html">エディタ</a>
のページで説明している <code>ParseFileResults</code> と <code>CheckFileResults</code> 型です。
たとえば以下のようなコードでエラーを確認出来ます:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs40', 70)" onmouseover="showTip(event, 'fs40', 70)" class="i">checkResults</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs43', 71)" onmouseover="showTip(event, 'fs43', 71)" class="i">Errors</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs44', 72)" onmouseover="showTip(event, 'fs44', 72)" class="i">Length</span> <span class="c">// 1</span>
</code></pre></td>
</tr>
</table>

<p>コードはF# Interactiveセッション内において、その時点までに実行された
有効な宣言からなる論理的な型コンテキストと結びつく形でチェックされます。</p>

<p>また、宣言リスト情報やツールチップテキスト、シンボルの解決といった処理を
要求することもできます:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
<span class="l">9: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">open</span> <span onmouseout="hideTip(event, 'fs1', 73)" onmouseover="showTip(event, 'fs1', 73)" class="i">Microsoft</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs2', 74)" onmouseover="showTip(event, 'fs2', 74)" class="i">FSharp</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 75)" onmouseover="showTip(event, 'fs3', 75)" class="i">Compiler</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs45', 76)" onmouseover="showTip(event, 'fs45', 76)" class="i">identToken</span> <span class="o">=</span> <span class="i">Parser</span><span class="o">.</span><span class="i">tagOfToken</span>(<span class="i">Parser</span><span class="o">.</span><span class="i">token</span><span class="o">.</span><span class="i">IDENT</span>(<span class="s">&quot;&quot;</span>)) 
<span onmouseout="hideTip(event, 'fs46', 77)" onmouseover="showTip(event, 'fs46', 77)" class="i">checkResults</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs47', 78)" onmouseover="showTip(event, 'fs47', 78)" class="f">GetToolTipTextAlternate</span>(<span class="n">1</span>, <span class="n">2</span>, <span class="s">&quot;xxx + xx&quot;</span>, [<span class="s">&quot;xxx&quot;</span>], <span onmouseout="hideTip(event, 'fs45', 79)" onmouseover="showTip(event, 'fs45', 79)" class="i">identToken</span>) <span class="c">// a tooltip</span>

<span class="k">let</span> <span onmouseout="hideTip(event, 'fs48', 80)" onmouseover="showTip(event, 'fs48', 80)" class="i">symbolUse</span> <span class="o">=</span> 
    <span onmouseout="hideTip(event, 'fs46', 81)" onmouseover="showTip(event, 'fs46', 81)" class="i">checkResults</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs49', 82)" onmouseover="showTip(event, 'fs49', 82)" class="f">GetSymbolUseAtLocation</span>(<span class="n">1</span>, <span class="n">2</span>, <span class="s">&quot;xxx + xx&quot;</span>, [<span class="s">&quot;xxx&quot;</span>]) 
    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs50', 83)" onmouseover="showTip(event, 'fs50', 83)" class="t">Async</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 84)" onmouseover="showTip(event, 'fs51', 84)" class="f">RunSynchronously</span>
  
</code></pre></td>
</tr>
</table>

<h2><a name="例外処理" class="anchor" href="#例外処理">例外処理</a></h2>

<p>コンパイルエラーをもっと洗練された形で処理して、
使い勝手のよいエラーメッセージを出力させたい場合には
以下のようにするとよいでしょう:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">try</span> 
  <span onmouseout="hideTip(event, 'fs26', 85)" onmouseover="showTip(event, 'fs26', 85)" class="f">evalExpression</span> <span class="s">&quot;42 + 1.0&quot;</span>
<span class="k">with</span> <span onmouseout="hideTip(event, 'fs52', 86)" onmouseover="showTip(event, 'fs52', 86)" class="i">e</span> <span class="k">-&gt;</span>
  <span class="k">match</span> <span onmouseout="hideTip(event, 'fs52', 87)" onmouseover="showTip(event, 'fs52', 87)" class="i">e</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs53', 88)" onmouseover="showTip(event, 'fs53', 88)" class="i">InnerException</span> <span class="k">with</span>
  | <span class="k">null</span> <span class="k">-&gt;</span> 
      <span onmouseout="hideTip(event, 'fs31', 89)" onmouseover="showTip(event, 'fs31', 89)" class="f">printfn</span> <span class="s">&quot;式 (</span><span class="pf">%s</span><span class="s">) の評価時にエラーが発生しました&quot;</span> <span onmouseout="hideTip(event, 'fs52', 90)" onmouseover="showTip(event, 'fs52', 90)" class="i">e</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs54', 91)" onmouseover="showTip(event, 'fs54', 91)" class="i">Message</span>
  <span class="c">//| WrappedError(err, _) -&gt; </span>
  <span class="c">//    printfn &quot;(ラップされた)式 (%s) の評価時にエラーが発生しました&quot; err.Message</span>
  | _ <span class="k">-&gt;</span> 
      <span onmouseout="hideTip(event, 'fs31', 92)" onmouseover="showTip(event, 'fs31', 92)" class="f">printfn</span> <span class="s">&quot;式 (</span><span class="pf">%s</span><span class="s">) の評価時にエラーが発生しました&quot;</span> <span onmouseout="hideTip(event, 'fs52', 93)" onmouseover="showTip(event, 'fs52', 93)" class="i">e</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs54', 94)" onmouseover="showTip(event, 'fs54', 94)" class="i">Message</span>
</code></pre></td>
</tr>
</table>

<div class="tip" id="fs1">namespace Microsoft</div>
<div class="tip" id="fs2">namespace Microsoft.FSharp</div>
<div class="tip" id="fs3">namespace Microsoft.FSharp.Compiler</div>
<div class="tip" id="fs4">namespace Microsoft.FSharp.Compiler.Interactive</div>
<div class="tip" id="fs5">module Shell<br /><br />from Microsoft.FSharp.Compiler.Interactive</div>
<div class="tip" id="fs6">namespace System</div>
<div class="tip" id="fs7">namespace System.IO</div>
<div class="tip" id="fs8">val sbOut : Text.StringBuilder<br /><br />Full name: Interactive.sbOut</div>
<div class="tip" id="fs9">namespace System.Text</div>
<div class="tip" id="fs10">Multiple items<br />type StringBuilder =<br />&#160;&#160;new : unit -&gt; StringBuilder + 5 overloads<br />&#160;&#160;member Append : value:string -&gt; StringBuilder + 18 overloads<br />&#160;&#160;member AppendFormat : format:string * arg0:obj -&gt; StringBuilder + 4 overloads<br />&#160;&#160;member AppendLine : unit -&gt; StringBuilder + 1 overload<br />&#160;&#160;member Capacity : int with get, set<br />&#160;&#160;member Chars : int -&gt; char with get, set<br />&#160;&#160;member Clear : unit -&gt; StringBuilder<br />&#160;&#160;member CopyTo : sourceIndex:int * destination:char[] * destinationIndex:int * count:int -&gt; unit<br />&#160;&#160;member EnsureCapacity : capacity:int -&gt; int<br />&#160;&#160;member Equals : sb:StringBuilder -&gt; bool<br />&#160;&#160;...<br /><br />Full name: System.Text.StringBuilder<br /><br />--------------------<br />Text.StringBuilder() : unit<br />Text.StringBuilder(capacity: int) : unit<br />Text.StringBuilder(value: string) : unit<br />Text.StringBuilder(value: string, capacity: int) : unit<br />Text.StringBuilder(capacity: int, maxCapacity: int) : unit<br />Text.StringBuilder(value: string, startIndex: int, length: int, capacity: int) : unit</div>
<div class="tip" id="fs11">val sbErr : Text.StringBuilder<br /><br />Full name: Interactive.sbErr</div>
<div class="tip" id="fs12">val inStream : StringReader<br /><br />Full name: Interactive.inStream</div>
<div class="tip" id="fs13">Multiple items<br />type StringReader =<br />&#160;&#160;inherit TextReader<br />&#160;&#160;new : s:string -&gt; StringReader<br />&#160;&#160;member Close : unit -&gt; unit<br />&#160;&#160;member Peek : unit -&gt; int<br />&#160;&#160;member Read : unit -&gt; int + 1 overload<br />&#160;&#160;member ReadLine : unit -&gt; string<br />&#160;&#160;member ReadToEnd : unit -&gt; string<br /><br />Full name: System.IO.StringReader<br /><br />--------------------<br />StringReader(s: string) : unit</div>
<div class="tip" id="fs14">val outStream : StringWriter<br /><br />Full name: Interactive.outStream</div>
<div class="tip" id="fs15">Multiple items<br />type StringWriter =<br />&#160;&#160;inherit TextWriter<br />&#160;&#160;new : unit -&gt; StringWriter + 3 overloads<br />&#160;&#160;member Close : unit -&gt; unit<br />&#160;&#160;member Encoding : Encoding<br />&#160;&#160;member GetStringBuilder : unit -&gt; StringBuilder<br />&#160;&#160;member ToString : unit -&gt; string<br />&#160;&#160;member Write : value:char -&gt; unit + 2 overloads<br /><br />Full name: System.IO.StringWriter<br /><br />--------------------<br />StringWriter() : unit<br />StringWriter(formatProvider: IFormatProvider) : unit<br />StringWriter(sb: Text.StringBuilder) : unit<br />StringWriter(sb: Text.StringBuilder, formatProvider: IFormatProvider) : unit</div>
<div class="tip" id="fs16">val errStream : StringWriter<br /><br />Full name: Interactive.errStream</div>
<div class="tip" id="fs17">val argv : string []<br /><br />Full name: Interactive.argv</div>
<div class="tip" id="fs18">val allArgs : string []<br /><br />Full name: Interactive.allArgs</div>
<div class="tip" id="fs19">type Array =<br />&#160;&#160;member Clone : unit -&gt; obj<br />&#160;&#160;member CopyTo : array:Array * index:int -&gt; unit + 1 overload<br />&#160;&#160;member GetEnumerator : unit -&gt; IEnumerator<br />&#160;&#160;member GetLength : dimension:int -&gt; int<br />&#160;&#160;member GetLongLength : dimension:int -&gt; int64<br />&#160;&#160;member GetLowerBound : dimension:int -&gt; int<br />&#160;&#160;member GetUpperBound : dimension:int -&gt; int<br />&#160;&#160;member GetValue : [&lt;ParamArray&gt;] indices:int[] -&gt; obj + 7 overloads<br />&#160;&#160;member Initialize : unit -&gt; unit<br />&#160;&#160;member IsFixedSize : bool<br />&#160;&#160;...<br /><br />Full name: System.Array</div>
<div class="tip" id="fs20">val append : array1:&#39;T [] -&gt; array2:&#39;T [] -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Array.append</div>
<div class="tip" id="fs21">val fsiConfig : FsiEvaluationSessionHostConfig<br /><br />Full name: Interactive.fsiConfig</div>
<div class="tip" id="fs22">type FsiEvaluationSession =<br />&#160;&#160;interface IDisposable<br />&#160;&#160;member EvalExpression : code:string -&gt; FsiValue option<br />&#160;&#160;member EvalInteraction : code:string -&gt; unit<br />&#160;&#160;member EvalScript : filePath:string -&gt; unit<br />&#160;&#160;member GetCompletions : longIdent:string -&gt; seq&lt;string&gt;<br />&#160;&#160;member Interrupt : unit -&gt; unit<br />&#160;&#160;member ParseAndCheckInteraction : code:string -&gt; FSharpParseFileResults * FSharpCheckFileResults * FSharpCheckProjectResults<br />&#160;&#160;member ReportUnhandledException : exn:exn -&gt; unit<br />&#160;&#160;member Run : unit -&gt; unit<br />&#160;&#160;member CurrentPartialAssemblySignature : FSharpAssemblySignature<br />&#160;&#160;...<br /><br />Full name: Microsoft.FSharp.Compiler.Interactive.Shell.FsiEvaluationSession</div>
<div class="tip" id="fs23">static member FsiEvaluationSession.GetDefaultConfiguration : unit -&gt; FsiEvaluationSessionHostConfig<br />static member FsiEvaluationSession.GetDefaultConfiguration : fsiObj:obj -&gt; FsiEvaluationSessionHostConfig<br />static member FsiEvaluationSession.GetDefaultConfiguration : fsiObj:obj * useFsiAuxLib:bool -&gt; FsiEvaluationSessionHostConfig</div>
<div class="tip" id="fs24">val fsiSession : FsiEvaluationSession<br /><br />Full name: Interactive.fsiSession</div>
<div class="tip" id="fs25">static member FsiEvaluationSession.Create : fsiConfig:FsiEvaluationSessionHostConfig * argv:string [] * inReader:TextReader * outWriter:TextWriter * errorWriter:TextWriter * ?collectible:bool -&gt; FsiEvaluationSession</div>
<div class="tip" id="fs26">val evalExpression : text:string -&gt; unit<br /><br />Full name: Interactive.evalExpression<br /><em><br /><br />&#160;式を評価して結果を返す</em></div>
<div class="tip" id="fs27">val text : string</div>
<div class="tip" id="fs28">member FsiEvaluationSession.EvalExpression : code:string -&gt; FsiValue option</div>
<div class="tip" id="fs29">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs30">val value : FsiValue</div>
<div class="tip" id="fs31">val printfn : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printfn</div>
<div class="tip" id="fs32">property FsiValue.ReflectionValue: obj</div>
<div class="tip" id="fs33">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs34">val evalInteraction : text:string -&gt; unit<br /><br />Full name: Interactive.evalInteraction<br /><em><br /><br />&#160;命令を評価して、結果は無視する</em></div>
<div class="tip" id="fs35">member FsiEvaluationSession.EvalInteraction : code:string -&gt; unit</div>
<div class="tip" id="fs36">val evalScript : scriptPath:string -&gt; unit<br /><br />Full name: Interactive.evalScript<br /><em><br /><br />&#160;スクリプトを評価して結果を無視する</em></div>
<div class="tip" id="fs37">val scriptPath : string</div>
<div class="tip" id="fs38">member FsiEvaluationSession.EvalScript : filePath:string -&gt; unit</div>
<div class="tip" id="fs39">val parseResults : Compiler.SourceCodeServices.FSharpParseFileResults<br /><br />Full name: Interactive.parseResults</div>
<div class="tip" id="fs40">val checkResults : Compiler.SourceCodeServices.FSharpCheckFileResults<br /><br />Full name: Interactive.checkResults</div>
<div class="tip" id="fs41">val checkProjectResults : Compiler.SourceCodeServices.FSharpCheckProjectResults<br /><br />Full name: Interactive.checkProjectResults</div>
<div class="tip" id="fs42">member FsiEvaluationSession.ParseAndCheckInteraction : code:string -&gt; Compiler.SourceCodeServices.FSharpParseFileResults * Compiler.SourceCodeServices.FSharpCheckFileResults * Compiler.SourceCodeServices.FSharpCheckProjectResults</div>
<div class="tip" id="fs43">property Compiler.SourceCodeServices.FSharpCheckFileResults.Errors: Compiler.FSharpErrorInfo []</div>
<div class="tip" id="fs44">property Array.Length: int</div>
<div class="tip" id="fs45">val identToken : int<br /><br />Full name: Interactive.identToken</div>
<div class="tip" id="fs46">val checkResults : SourceCodeServices.FSharpCheckFileResults<br /><br />Full name: Interactive.checkResults</div>
<div class="tip" id="fs47">member SourceCodeServices.FSharpCheckFileResults.GetToolTipTextAlternate : line:int * colAtEndOfNames:int * lineText:string * names:string list * tokenTag:int -&gt; Async&lt;SourceCodeServices.ToolTipText&gt;</div>
<div class="tip" id="fs48">val symbolUse : SourceCodeServices.FSharpSymbolUse option<br /><br />Full name: Interactive.symbolUse</div>
<div class="tip" id="fs49">member SourceCodeServices.FSharpCheckFileResults.GetSymbolUseAtLocation : line:int * colAtEndOfNames:int * lineText:string * names:string list -&gt; Async&lt;SourceCodeServices.FSharpSymbolUse option&gt;</div>
<div class="tip" id="fs50">Multiple items<br />type Async<br />static member AsBeginEnd : computation:(&#39;Arg -&gt; Async&lt;&#39;T&gt;) -&gt; (&#39;Arg * AsyncCallback * obj -&gt; IAsyncResult) * (IAsyncResult -&gt; &#39;T) * (IAsyncResult -&gt; unit)<br />static member AwaitEvent : event:IEvent&lt;&#39;Del,&#39;T&gt; * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt; (requires delegate and &#39;Del :&gt; Delegate)<br />static member AwaitIAsyncResult : iar:IAsyncResult * ?millisecondsTimeout:int -&gt; Async&lt;bool&gt;<br />static member AwaitTask : task:Task -&gt; Async&lt;unit&gt;<br />static member AwaitTask : task:Task&lt;&#39;T&gt; -&gt; Async&lt;&#39;T&gt;<br />static member AwaitWaitHandle : waitHandle:WaitHandle * ?millisecondsTimeout:int -&gt; Async&lt;bool&gt;<br />static member CancelDefaultToken : unit -&gt; unit<br />static member Catch : computation:Async&lt;&#39;T&gt; -&gt; Async&lt;Choice&lt;&#39;T,exn&gt;&gt;<br />static member FromBeginEnd : beginAction:(AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg:&#39;Arg1 * beginAction:(&#39;Arg1 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * beginAction:(&#39;Arg1 * &#39;Arg2 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromBeginEnd : arg1:&#39;Arg1 * arg2:&#39;Arg2 * arg3:&#39;Arg3 * beginAction:(&#39;Arg1 * &#39;Arg2 * &#39;Arg3 * AsyncCallback * obj -&gt; IAsyncResult) * endAction:(IAsyncResult -&gt; &#39;T) * ?cancelAction:(unit -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member FromContinuations : callback:((&#39;T -&gt; unit) * (exn -&gt; unit) * (OperationCanceledException -&gt; unit) -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member Ignore : computation:Async&lt;&#39;T&gt; -&gt; Async&lt;unit&gt;<br />static member OnCancel : interruption:(unit -&gt; unit) -&gt; Async&lt;IDisposable&gt;<br />static member Parallel : computations:seq&lt;Async&lt;&#39;T&gt;&gt; -&gt; Async&lt;&#39;T []&gt;<br />static member RunSynchronously : computation:Async&lt;&#39;T&gt; * ?timeout:int * ?cancellationToken:CancellationToken -&gt; &#39;T<br />static member Sleep : millisecondsDueTime:int -&gt; Async&lt;unit&gt;<br />static member Start : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit<br />static member StartAsTask : computation:Async&lt;&#39;T&gt; * ?taskCreationOptions:TaskCreationOptions * ?cancellationToken:CancellationToken -&gt; Task&lt;&#39;T&gt;<br />static member StartChild : computation:Async&lt;&#39;T&gt; * ?millisecondsTimeout:int -&gt; Async&lt;Async&lt;&#39;T&gt;&gt;<br />static member StartChildAsTask : computation:Async&lt;&#39;T&gt; * ?taskCreationOptions:TaskCreationOptions -&gt; Async&lt;Task&lt;&#39;T&gt;&gt;<br />static member StartImmediate : computation:Async&lt;unit&gt; * ?cancellationToken:CancellationToken -&gt; unit<br />static member StartWithContinuations : computation:Async&lt;&#39;T&gt; * continuation:(&#39;T -&gt; unit) * exceptionContinuation:(exn -&gt; unit) * cancellationContinuation:(OperationCanceledException -&gt; unit) * ?cancellationToken:CancellationToken -&gt; unit<br />static member SwitchToContext : syncContext:SynchronizationContext -&gt; Async&lt;unit&gt;<br />static member SwitchToNewThread : unit -&gt; Async&lt;unit&gt;<br />static member SwitchToThreadPool : unit -&gt; Async&lt;unit&gt;<br />static member TryCancelled : computation:Async&lt;&#39;T&gt; * compensation:(OperationCanceledException -&gt; unit) -&gt; Async&lt;&#39;T&gt;<br />static member CancellationToken : Async&lt;CancellationToken&gt;<br />static member DefaultCancellationToken : CancellationToken<br /><br />Full name: Microsoft.FSharp.Control.Async<br /><br />--------------------<br />type Async&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Control.Async&lt;_&gt;</div>
<div class="tip" id="fs51">static member Async.RunSynchronously : computation:Async&lt;&#39;T&gt; * ?timeout:int * ?cancellationToken:Threading.CancellationToken -&gt; &#39;T</div>
<div class="tip" id="fs52">val e : exn</div>
<div class="tip" id="fs53">property Exception.InnerException: exn</div>
<div class="tip" id="fs54">property Exception.Message: string</div>

        </div>
        <div class="span3">
           <a href="https://nuget.org/packages/FSharp.Compiler.Service">
            <img src="/FSharp.Compiler.Service/ja/../images/logo.png" style="width:140px;height:140px;margin:10px 0px 0px 35px;border-style:none;" />
          </a>
          <ul class="nav nav-list" id="menu">
            <li class="nav-header">
			<a href="/FSharp.Compiler.Service/ja/../ja/index.html" class="nflag"><img src="/FSharp.Compiler.Service/ja/../images/ja.png" /></a>
            <a href="/FSharp.Compiler.Service/ja/../index.html" class="nflag nflag2"><img src="/FSharp.Compiler.Service/ja/../images/en.png" /></a>
			F# Compiler Services
			</li>
            <li><a href="/FSharp.Compiler.Service/ja/index.html">ホームページ</a></li>
            <li class="divider"></li>
            <li><a href="https://www.nuget.org/packages/FSharp.Compiler.Service">NuGet経由でライブラリを取得</a></li>
            <li><a href="http://github.com/fsharp/FSharp.Compiler.Service">GitHub上のソースコード</a></li>
            <li><a href="http://github.com/fsharp/FSharp.Compiler.Service/blob/master/LICENSE">ライセンス</a></li>
            <li><a href="http://github.com/fsharp/FSharp.Compiler.Service/blob/master/RELEASE_NOTES.md">リリースノート</a></li>
            
            <li class="nav-header">はじめに</li>
            <li><a href="/FSharp.Compiler.Service/ja/index.html">ホームページ</a></li>
            <li><a href="/FSharp.Compiler.Service/ja/devnotes.html">開発者用メモ</a></li>
            <li><a href="/FSharp.Compiler.Service/ja/fsharp-readme.html">F#コンパイラのreadme</a></li>

            <li class="nav-header">利用可能なサービス</li>
            <li><a href="/FSharp.Compiler.Service/ja/tokenizer.html">F#言語トークナイザ</a></li>
            <li><a href="/FSharp.Compiler.Service/ja/untypedtree.html">型無しASTの処理</a></li>
            <li><a href="/FSharp.Compiler.Service/ja/editor.html">エディタ(IDE)のサービスを使用する</a></li>
            <li><a href="/FSharp.Compiler.Service/ja/symbols.html">解決済みのシンボルを使用する</a></li>
            <li><a href="/FSharp.Compiler.Service/ja/project.html">プロジェクト全体の分析</a></li>
            <li><a href="/FSharp.Compiler.Service/ja/interactive.html">F# Interactiveの組み込み</a></li>
            <li><a href="/FSharp.Compiler.Service/ja/compiler.html">F#コンパイラの組み込み</a></li>
            <li><a href="/FSharp.Compiler.Service/ja/filesystem.html">ファイルシステムの仮想化</a></li>

            <li class="nav-header">リファレンス</li>
            <li><a href="/FSharp.Compiler.Service/ja/../reference/index.html">API リファレンス</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/fsharp/FSharp.Compiler.Service"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
  </body>
  </html>
